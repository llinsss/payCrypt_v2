name: PR Automation Bot

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    paths:
      - 'backend/**'
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write

jobs:
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      is_valid: ${{ steps.validate.outputs.is_valid }}
      issue_number: ${{ steps.extract.outputs.issue_number }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract issue number from PR
        id: extract
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          
          ISSUE_NUM=$(echo "$PR_TITLE $PR_BODY" | grep -oP '(?<=#)\d+' | head -1)
          
          if [ -z "$ISSUE_NUM" ]; then
            echo "issue_number=none" >> $GITHUB_OUTPUT
          else
            echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          fi

      - name: Validate PR structure
        id: validate
        run: |
          IS_VALID=true
          ERRORS=""
          
          if [ "${{ steps.extract.outputs.issue_number }}" == "none" ]; then
            IS_VALID=false
            ERRORS="${ERRORS}\n- PR must reference an issue number"
          fi
          
          BACKEND_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^backend/' | wc -l)
          if [ "$BACKEND_FILES" -eq 0 ]; then
            IS_VALID=false
            ERRORS="${ERRORS}\n- PR must modify files in backend/"
          fi
          
          if ! echo "${{ github.event.pull_request.title }}" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|ci)(\(.+\))?: .+'; then
            IS_VALID=false
            ERRORS="${ERRORS}\n- PR title must follow conventional commits"
          fi
          
          echo "is_valid=$IS_VALID" >> $GITHUB_OUTPUT
          echo "errors<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ERRORS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment validation errors
        if: steps.validate.outputs.is_valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const errors = `${{ steps.validate.outputs.errors }}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ‚ùå PR Validation Failed\n\nPlease fix:\n${errors}`
            });

      - name: Add validation label
        uses: actions/github-script@v7
        with:
          script: |
            const isValid = '${{ steps.validate.outputs.is_valid }}' === 'true';
            const label = isValid ? 'validation-passed' : 'validation-failed';
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label]
            });

  backend-tests:
    name: Run Backend Tests
    runs-on: ubuntu-latest
    needs: pr-validation
    if: needs.pr-validation.outputs.is_valid == 'true'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: tagged_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run linter
        working-directory: ./backend
        run: npm run lint || echo "No lint script"

      - name: Run tests
        working-directory: ./backend
        env:
          NODE_ENV: test
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_USERNAME: test
          DATABASE_PASSWORD: test
          DATABASE_NAME: tagged_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: npm test || echo "No tests"

      - name: Comment test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${emoji} Backend tests ${status}`
            });

  code-review:
    name: Automated Code Review
    runs-on: ubuntu-latest
    needs: [pr-validation, backend-tests]
    if: needs.pr-validation.outputs.is_valid == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze code changes
        id: analyze
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^backend/')
          
          ISSUES=0
          WARNINGS=0
          SUGGESTIONS=""
          
          if echo "$CHANGED_FILES" | xargs grep -n "console.log" 2>/dev/null; then
            ISSUES=$((ISSUES + 1))
            SUGGESTIONS="${SUGGESTIONS}\n- Remove console.log statements"
          fi
          
          if echo "$CHANGED_FILES" | xargs grep -niE "(password|secret|api_key|token)\s*=\s*['\"][^'\"]+['\"]" 2>/dev/null; then
            ISSUES=$((ISSUES + 1))
            SUGGESTIONS="${SUGGESTIONS}\n- ‚ö†Ô∏è Possible hardcoded credentials"
          fi
          
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "suggestions<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUGGESTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post code review
        uses: actions/github-script@v7
        with:
          script: |
            const issues = parseInt('${{ steps.analyze.outputs.issues }}');
            const warnings = parseInt('${{ steps.analyze.outputs.warnings }}');
            const suggestions = `${{ steps.analyze.outputs.suggestions }}`;
            
            let reviewBody = '## ü§ñ Automated Code Review\n\n';
            
            if (issues === 0 && warnings === 0) {
              reviewBody += '‚úÖ No issues found!\n';
            } else {
              reviewBody += `**Issues:** ${issues}\n**Warnings:** ${warnings}\n\n`;
              if (suggestions) reviewBody += '**Suggestions:**\n' + suggestions + '\n';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewBody
            });
            
            const labels = [];
            if (issues > 0) labels.push('needs-changes');
            if (issues === 0 && warnings === 0) labels.push('ready-for-review');
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }

  auto-merge:
    name: Auto Merge PR
    runs-on: ubuntu-latest
    needs: [pr-validation, backend-tests, code-review]
    if: |
      needs.pr-validation.outputs.is_valid == 'true' &&
      needs.backend-tests.result == 'success' &&
      needs.code-review.result == 'success'
    
    steps:
      - name: Check approval status
        id: check-approval
        uses: actions/github-script@v7
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const approvals = reviews.filter(r => r.state === 'APPROVED').length;
            const changesRequested = reviews.filter(r => r.state === 'CHANGES_REQUESTED').length;
            
            const canMerge = approvals >= 1 && changesRequested === 0;
            
            core.setOutput('can_merge', canMerge);
            core.setOutput('approvals', approvals);
            return canMerge;

      - name: Auto-merge PR
        if: steps.check-approval.outputs.can_merge == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'squash',
                commit_title: `${{ github.event.pull_request.title }} (#${{ github.event.pull_request.number }})`,
                commit_message: 'Auto-merged by Tagged Bot'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'üéâ PR automatically merged!'
              });
              
              const issueNum = '${{ needs.pr-validation.outputs.issue_number }}';
              if (issueNum !== 'none') {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNum),
                  state: 'closed'
                });
              }
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '‚ùå Auto-merge failed. Please merge manually.'
              });
            }

      - name: Request review if not approved
        if: steps.check-approval.outputs.can_merge == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const approvals = '${{ steps.check-approval.outputs.approvals }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚è≥ Waiting for approval (${approvals}/1 required)`
            });

  handle-commands:
    name: Handle Bot Commands
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/bot')
    
    steps:
      - name: Process command
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const commands = {
              '/bot retest': 'Retriggering tests...',
              '/bot merge': 'Attempting to merge...',
              '/bot review': 'Running code review...',
              '/bot help': 'Commands:\n- `/bot retest`\n- `/bot merge`\n- `/bot review`\n- `/bot help`'
            };
            
            let response = 'Unknown command. Use `/bot help`';
            
            for (const [cmd, msg] of Object.entries(commands)) {
              if (comment.startsWith(cmd)) {
                response = msg;
                break;
              }
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: response
            });
